<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pencatatan Transaksi Agen</title>
    <!-- Memuat Tailwind CSS melalui CDN untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat library ikon untuk visual yang lebih baik -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <!-- Memuat library untuk ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Memuat library untuk Grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { padding-bottom: 80px; }
        .form-section, .sub-form { display: none; }
        .form-section.active, .sub-form.active { display: grid; }
        input:disabled, select:disabled {
            background-color: #f3f4f6; /* bg-slate-100 */
            cursor: not-allowed;
        }
        #confirmation-modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-slate-100 font-sans">

    <!-- Kontainer Utama Aplikasi -->
    <div class="container mx-auto max-w-5xl p-4 sm:p-6 lg:p-8">

        <!-- Header Aplikasi -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">Catatan Transaksi <br> = NPAR Media =</h1>
            <p id="page-title" class="text-slate-500 mt-2">Dashboard</p>
        </header>

        <!-- KONTEN HALAMAN -->
        <main>
            <!-- HALAMAN DASHBOARD -->
            <div id="page-dashboard" class="page-content space-y-8">
                <!-- Saldo Awal -->
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold text-slate-700 mb-4 flex items-center"><i class="fa-solid fa-flag-checkered mr-3 text-indigo-500"></i> Saldo Awal Hari Ini</h2>
                    <div id="initial-balances-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        <!-- Input saldo akan digenerate oleh JS -->
                    </div>
                    <button id="save-initial-balance" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition-all shadow-md flex items-center justify-center"><i class="fa-solid fa-floppy-disk mr-2"></i> Atur & Kunci Saldo</button>
                </section>
                <!-- Saldo Terkini -->
                <section>
                    <h2 class="text-xl font-semibold text-slate-700 mb-4">Ringkasan Saldo Terkini</h2>
                    <div id="current-balances-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 text-center">
                        <!-- Kartu saldo akan digenerate oleh JS -->
                    </div>
                </section>
                <!-- Grafik Laba -->
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                        <h2 class="text-xl font-semibold text-slate-700 flex items-center mb-4 sm:mb-0">
                            <i class="fa-solid fa-chart-line mr-3 text-cyan-500"></i> Analisis Laba
                        </h2>
                        <div id="chart-filter-buttons" class="flex bg-slate-100 rounded-lg p-1">
                            <button data-period="daily" class="chart-filter-btn flex-1 px-4 py-2 text-sm font-semibold rounded-md bg-white text-cyan-600 shadow">Harian</button>
                            <button data-period="monthly" class="chart-filter-btn flex-1 px-4 py-2 text-sm font-semibold rounded-md text-slate-500">Bulanan</button>
                            <button data-period="yearly" class="chart-filter-btn flex-1 px-4 py-2 text-sm font-semibold rounded-md text-slate-500">Tahunan</button>
                        </div>
                    </div>
                    <div>
                        <canvas id="profitChart"></canvas>
                    </div>
                </section>
            </div>

            <!-- HALAMAN TRANSAKSI -->
            <div id="page-transaksi" class="page-content hidden">
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold text-slate-700 mb-4 flex items-center"><i class="fa-solid fa-plus-circle mr-3 text-sky-500"></i> Tambah Transaksi Baru</h2>
                    <form id="transaction-form">
                        <!-- Pilihan Kategori Utama -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="category" class="block text-sm font-medium text-slate-600 mb-1">Kategori Transaksi</label>
                                <select id="category" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 transition">
                                    <option value="flow">Aliran Dana (Transfer/Tarik)</option>
                                    <option value="sale">Penjualan Produk & Tagihan</option>
                                    <option value="internal">Transfer Antar Akun</option>
                                    <option value="adjustment">Penyesuaian Saldo</option>
                                </select>
                            </div>
                            <div>
                                <label for="sub-category" class="block text-sm font-medium text-slate-600 mb-1">Jenis Layanan</label>
                                <select id="sub-category" required class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 transition"></select>
                            </div>
                        </div>

                        <!-- Form untuk Kategori Aliran Dana -->
                        <div id="form-flow" class="form-section active grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="amount-flow" class="block text-sm font-medium text-slate-600 mb-1">Nominal (Rp)</label>
                                <input type="number" id="amount-flow" placeholder="500000" class="w-full p-3 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label for="customer-flow" class="block text-sm font-medium text-slate-600 mb-1">Nama Pelanggan</label>
                                <input type="text" id="customer-flow" placeholder="Budi Santoso" class="w-full p-3 border border-slate-300 rounded-lg">
                            </div>
                            <div id="source-account-flow-container" class="sub-form active">
                                <label for="source-account-flow" class="block text-sm font-medium text-slate-600 mb-1">Sumber Dana</label>
                                <select id="source-account-flow" class="w-full p-3 border border-slate-300 rounded-lg"></select>
                            </div>
                            <div id="destination-account-flow-container" class="sub-form">
                                <label for="destination-account-flow" class="block text-sm font-medium text-slate-600 mb-1">Tujuan Transfer Pelanggan</label>
                                <select id="destination-account-flow" class="w-full p-3 border border-slate-300 rounded-lg"></select>
                            </div>
                            <div id="admin-fee-method-container" class="sub-form md:col-span-2">
                                <label class="block text-sm font-medium text-slate-600 mb-2">Metode Bayar Admin</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center p-3 border rounded-lg flex-1 cursor-pointer"><input type="radio" name="admin-fee-method" value="cash" class="mr-2" checked> Tunai</label>
                                    <label class="flex items-center p-3 border rounded-lg flex-1 cursor-pointer"><input type="radio" name="admin-fee-method" value="transfer" class="mr-2"> Via Transfer</label>
                                </div>
                            </div>
                        </div>

                        <!-- Form untuk Kategori Penjualan Produk -->
                        <div id="form-sale" class="form-section grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                             <div>
                                <label for="source-account-sale" class="block text-sm font-medium text-slate-600 mb-1">Sumber Dana</label>
                                <select id="source-account-sale" class="w-full p-3 border border-slate-300 rounded-lg"></select>
                            </div>
                            <div>
                                <label for="base-price" class="block text-sm font-medium text-slate-600 mb-1">Harga Dasar (Rp)</label>
                                <input type="number" id="base-price" placeholder="15000" class="w-full p-3 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label for="sell-price" class="block text-sm font-medium text-slate-600 mb-1">Harga Jual (Rp)</label>
                                <input type="number" id="sell-price" placeholder="18000" class="w-full p-3 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label for="customer-sale" class="block text-sm font-medium text-slate-600 mb-1">Nama/ID Pelanggan</label>
                                <input type="text" id="customer-sale" placeholder="08123456789" class="w-full p-3 border border-slate-300 rounded-lg">
                            </div>
                        </div>
                        
                        <!-- Form untuk Transfer Internal -->
                        <div id="form-internal" class="form-section grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="source-account-internal" class="block text-sm font-medium text-slate-600 mb-1">Dari Akun</label>
                                <select id="source-account-internal" class="w-full p-3 border border-slate-300 rounded-lg"></select>
                            </div>
                             <div>
                                <label for="destination-account-internal" class="block text-sm font-medium text-slate-600 mb-1">Ke Akun</label>
                                <select id="destination-account-internal" class="w-full p-3 border border-slate-300 rounded-lg"></select>
                            </div>
                            <div>
                                <label for="amount-internal" class="block text-sm font-medium text-slate-600 mb-1">Jumlah Transfer (Rp)</label>
                                <input type="number" id="amount-internal" placeholder="1000000" class="w-full p-3 border border-slate-300 rounded-lg">
                            </div>
                        </div>

                        <!-- Form untuk Penyesuaian Saldo -->
                        <div id="form-adjustment" class="form-section grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="account-adjustment" class="block text-sm font-medium text-slate-600 mb-1">Pilih Akun</label>
                                <select id="account-adjustment" class="w-full p-3 border border-slate-300 rounded-lg"></select>
                            </div>
                             <div>
                                <label for="amount-adjustment" class="block text-sm font-medium text-slate-600 mb-1">Jumlah (Rp)</label>
                                <input type="number" id="amount-adjustment" placeholder="50000" class="w-full p-3 border border-slate-300 rounded-lg">
                            </div>
                            <div>
                                <label for="description-adjustment" class="block text-sm font-medium text-slate-600 mb-1">Keterangan</label>
                                <input type="text" id="description-adjustment" placeholder="Pinjam uang pribadi" class="w-full p-3 border border-slate-300 rounded-lg">
                            </div>
                        </div>

                        <!-- Tombol Simpan -->
                        <div class="mt-6">
                            <button type="submit" class="w-full bg-sky-600 text-white p-3 rounded-lg font-bold hover:bg-sky-700 transition-all shadow-md flex items-center justify-center"><i class="fa-solid fa-paper-plane mr-2"></i> Simpan Transaksi</button>
                        </div>
                    </form>
                </section>
            </div>

            <!-- HALAMAN LAPORAN -->
            <div id="page-laporan" class="page-content hidden space-y-8">
                 <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                        <h2 class="text-xl font-semibold text-slate-700 flex items-center whitespace-nowrap">
                            <i class="fa-solid fa-book-open mr-3 text-amber-500"></i> Laporan Keuangan
                        </h2>
                        <div class="flex w-full sm:w-auto gap-2">
                            <select id="report-filter" class="w-full sm:w-auto p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 transition">
                                <option value="daily">Laporan Harian</option>
                                <option value="weekly">Laporan Mingguan</option>
                                <option value="monthly">Laporan Bulanan</option>
                                <option value="yearly">Laporan Tahunan</option>
                            </select>
                            <button id="export-pdf-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-all flex items-center justify-center">
                                <i class="fa-solid fa-file-pdf mr-2"></i> PDF
                            </button>
                        </div>
                    </div>
                    <!-- Ringkasan Laba -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center mb-6">
                        <div class="bg-green-50 border border-green-200 p-4 rounded-xl">
                            <h3 class="text-md font-medium text-green-800">Total Laba</h3>
                            <p id="total-profit" class="text-2xl font-bold text-green-900 mt-1">Rp 0</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded-xl">
                            <h3 class="text-md font-medium text-blue-800">Jumlah Transaksi</h3>
                            <p id="total-transactions" class="text-2xl font-bold text-blue-900 mt-1">0</p>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-600 mb-4 border-t pt-4">Rincian Transaksi</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-slate-600 uppercase">
                                <tr>
                                    <th class="p-3 rounded-l-lg">Waktu</th>
                                    <th class="p-3">Layanan</th>
                                    <th class="p-3">Detail</th>
                                    <th class="p-3 text-right">Nominal</th>
                                    <th class="p-3 text-right">Laba</th>
                                    <th class="p-3 text-center rounded-r-lg">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="report-body" class="divide-y"></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- HALAMAN PENGATURAN -->
            <div id="page-pengaturan" class="page-content hidden">
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold text-slate-700 mb-6 flex items-center">
                        <i class="fa-solid fa-database mr-3 text-slate-500"></i> Manajemen Data
                    </h2>
                    <div class="space-y-4">
                        <div class="p-4 border rounded-lg">
                            <h3 class="font-semibold text-lg text-slate-800">Ekspor Data (Backup)</h3>
                            <p class="text-slate-600 mt-1 mb-4">Simpan semua data transaksi dan saldo Anda ke dalam sebuah file JSON. Simpan file ini di tempat yang aman.</p>
                            <button id="export-db-btn" class="w-full sm:w-auto bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center">
                                <i class="fa-solid fa-download mr-2"></i> Ekspor Sekarang
                            </button>
                        </div>
                        <div class="p-4 border border-red-300 rounded-lg">
                            <h3 class="font-semibold text-lg text-red-800">Impor Data (Restore)</h3>
                            <p class="text-slate-600 mt-1 mb-4">
                                <span class="font-bold text-red-600">PERINGATAN:</span> 
                                 Fitur ini akan menghapus SEMUA data yang ada saat ini dan menggantinya dengan data dari file backup. Gunakan dengan hati-hati.
                            </p>
                            <button id="import-db-btn" class="w-full sm:w-auto bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 transition flex items-center justify-center">
                                <i class="fa-solid fa-upload mr-2"></i> Impor dari File
                            </button>
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- BOTTOM NAVIGATION MENU -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-t-lg border-t border-slate-200">
        <div id="nav-menu" class="flex justify-around max-w-5xl mx-auto">
            <button data-target="page-dashboard" class="nav-button flex-1 p-3 text-center text-indigo-600"><i class="fa-solid fa-chart-pie text-xl"></i><span class="block text-xs font-semibold">Dashboard</span></button>
            <button data-target="page-transaksi" class="nav-button flex-1 p-3 text-center text-slate-500"><i class="fa-solid fa-exchange-alt text-xl"></i><span class="block text-xs font-semibold">Transaksi</span></button>
            <button data-target="page-laporan" class="nav-button flex-1 p-3 text-center text-slate-500"><i class="fa-solid fa-file-alt text-xl"></i><span class="block text-xs font-semibold">Laporan</span></button>
            <button data-target="page-pengaturan" class="nav-button flex-1 p-3 text-center text-slate-500"><i class="fa-solid fa-cog text-xl"></i><span class="block text-xs font-semibold">Pengaturan</span></button>
        </div>
    </nav>

    <!-- MODAL KONFIRMASI HAPUS -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full text-center">
            <i id="modal-icon" class="fa-solid fa-triangle-exclamation text-5xl text-red-500 mb-4"></i>
            <h3 id="modal-title" class="text-xl font-bold text-slate-800 mb-2">Anda Yakin?</h3>
            <p id="modal-text" class="text-slate-600 mb-6">Transaksi ini akan dihapus secara permanen.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="w-full py-3 px-4 bg-slate-200 text-slate-800 rounded-lg font-semibold hover:bg-slate-300 transition">Batal</button>
                <button id="confirm-delete-btn" class="w-full py-3 px-4 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>


    <!-- Logika Aplikasi (JavaScript) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- KONFIGURASI ---
            const DB_NAME = 'AgenTransactionDB_MultiAccount';
            const DB_VERSION = 1;
            const TX_STORE_NAME = 'transactions';
            const BALANCE_STORE_NAME = 'balances';
            let db;
            let actionToConfirm = null;
            let profitChartInstance = null;

            const ACCOUNTS = {
                bri: 'Bank BRI',
                seabank: 'SeaBank',
                dana: 'DANA',
                shopee: 'Mitra Shopee',
                cash: 'Uang Tunai (Kas)'
            };

            const subCategoryOptions = {
                'flow': ['Transfer Uang', 'Tarik Tunai'],
                'sale': ['Topup E-Wallet', 'Topup Pulsa', 'Topup Game', 'Token Listrik', 'Bayar BPJS', 'Bayar Internet'],
                'internal': ['Transfer Antar Akun'],
                'adjustment': ['Tambah Saldo', 'Kurangi Saldo']
            };

            // --- FUNGSI INISIALISASI DATABASE ---
            const initDB = () => new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (e) => { console.error('DB error:', e.target.error); reject('Error'); };
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(TX_STORE_NAME)) db.createObjectStore(TX_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains(BALANCE_STORE_NAME)) db.createObjectStore(BALANCE_STORE_NAME, { keyPath: 'date' });
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
            });

            // --- SELEKSI ELEMEN DOM ---
            const pageTitleEl = document.getElementById('page-title');
            const navMenu = document.getElementById('nav-menu');
            const transactionForm = document.getElementById('transaction-form');
            const categorySelect = document.getElementById('category');
            const subCategorySelect = document.getElementById('sub-category');
            const reportFilter = document.getElementById('report-filter');
            const saveInitialBalanceBtn = document.getElementById('save-initial-balance');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const reportBody = document.getElementById('report-body');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const exportDbBtn = document.getElementById('export-db-btn');
            const importDbBtn = document.getElementById('import-db-btn');
            const importFileInput = document.getElementById('import-file-input');
            const chartFilterButtons = document.getElementById('chart-filter-buttons');
            
            // --- FUNGSI PEMBANTU ---
            const formatCurrency = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
            const calculateAdminFee = (amount) => {
                if (amount <= 700000) return 5000;
                if (amount <= 1000000) return 7000;
                return 10000;
            };

            // --- FUNGSI MODAL KONFIRMASI ---
            const showConfirmationModal = (config) => {
                document.getElementById('modal-icon').className = config.icon;
                document.getElementById('modal-title').textContent = config.title;
                document.getElementById('modal-text').textContent = config.text;
                actionToConfirm = config.action;
                confirmationModal.classList.remove('hidden');
                setTimeout(() => confirmationModal.classList.remove('opacity-0'), 10);
            };

            const hideConfirmationModal = () => {
                confirmationModal.classList.add('opacity-0');
                setTimeout(() => confirmationModal.classList.add('hidden'), 300);
            };

            // --- FUNGSI NAVIGASI & UI ---
            const showPage = (targetId) => {
                document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
                document.getElementById(targetId).classList.remove('hidden');
                document.querySelectorAll('.nav-button').forEach(b => {
                    const isActive = b.dataset.target === targetId;
                    b.classList.toggle('text-indigo-600', isActive);
                    b.classList.toggle('text-slate-500', !isActive);
                });
                pageTitleEl.textContent = document.querySelector(`.nav-button[data-target="${targetId}"] span`).textContent;
                if (targetId === 'page-laporan') renderReport();
                if (targetId === 'page-dashboard') renderProfitChart();
            };

            const updateFormLayout = () => {
                const selectedCategory = categorySelect.value;
                const selectedSubCategory = subCategorySelect.value;
                
                subCategorySelect.innerHTML = '';
                subCategoryOptions[selectedCategory].forEach(opt => {
                    const optionEl = document.createElement('option');
                    optionEl.value = opt;
                    optionEl.textContent = opt;
                    subCategorySelect.appendChild(optionEl);
                });
                if (subCategoryOptions[selectedCategory].includes(selectedSubCategory)) {
                    subCategorySelect.value = selectedSubCategory;
                }

                document.querySelectorAll('.form-section').forEach(form => form.classList.remove('active'));
                document.getElementById(`form-${selectedCategory}`).classList.add('active');

                document.querySelectorAll('#transaction-form input, #transaction-form select').forEach(el => {
                    if (el.closest('.form-section') && !el.closest('.form-section.active')) {
                        el.disabled = true;
                        el.required = false;
                    } else {
                        el.disabled = false;
                        el.required = true;
                    }
                });
                
                const isTarikTunai = subCategorySelect.value === 'Tarik Tunai';
                document.getElementById('source-account-flow-container').classList.toggle('active', !isTarikTunai);
                document.getElementById('destination-account-flow-container').classList.toggle('active', isTarikTunai);
                document.getElementById('admin-fee-method-container').classList.toggle('active', isTarikTunai);
            };
            
            const populateAccountSelects = () => {
                const selects = document.querySelectorAll('select[id*="account"]');
                selects.forEach(select => {
                    select.innerHTML = '';
                    for (const [key, value] of Object.entries(ACCOUNTS)) {
                        if (select.id.includes('destination-account-internal') && key === 'cash') continue;
                        if (select.id.includes('source-account-internal') && key === 'cash') continue;
                        if (select.id.includes('destination-account-flow') && key === 'cash') continue;

                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = value;
                        select.appendChild(option);
                    }
                });
            };

            // --- FUNGSI OPERASI DATABASE ---
            const dbAction = (storeName, mode, action) => new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, mode);
                transaction.onerror = (e) => reject(e.target.error);
                action(transaction.objectStore(storeName), resolve, reject);
            });
            const saveData = (store, data) => dbAction(store, 'readwrite', (objStore, res) => { objStore.put(data).onsuccess = res; });
            const getData = (store, key) => dbAction(store, 'readonly', (objStore, res) => { objStore.get(key).onsuccess = (e) => res(e.target.result); });
            const getAllData = (store) => dbAction(store, 'readonly', (objStore, res) => { objStore.getAll().onsuccess = (e) => res(e.target.result); });
            const deleteData = (store, key) => dbAction(store, 'readwrite', (objStore, res) => { objStore.delete(key).onsuccess = res; });
            const clearData = (store) => dbAction(store, 'readwrite', (objStore, res) => { objStore.clear().onsuccess = res; });

            // --- FUNGSI RENDER & KALKULASI ---
            async function calculateFinalBalances(dateString) {
                const initialData = await getData(BALANCE_STORE_NAME, dateString);
                const initialBalances = initialData ? initialData.balances : {};

                let finalBalances = {};
                for (const key in ACCOUNTS) {
                    finalBalances[key] = initialBalances[key] || 0;
                }

                const allTransactions = await getAllData(TX_STORE_NAME);
                const dayTransactions = allTransactions.filter(tx => tx.date.startsWith(dateString));

                dayTransactions.forEach(tx => {
                    if (tx.subCategory === 'Transfer Uang') {
                        finalBalances[tx.source] -= tx.amount;
                        finalBalances.cash += tx.amount + tx.profit;
                    } else if (tx.subCategory === 'Tarik Tunai') {
                        finalBalances.cash -= tx.amount;
                        if (tx.adminFeeMethod === 'cash') {
                            finalBalances.cash += tx.profit;
                            finalBalances[tx.destination] += tx.amount;
                        } else {
                            finalBalances[tx.destination] += tx.amount + tx.profit;
                        }
                    } else if (tx.category === 'sale') {
                        finalBalances[tx.source] -= tx.amount;
                        finalBalances.cash += tx.sellPrice;
                    } else if (tx.category === 'internal') {
                        finalBalances[tx.source] -= tx.amount;
                        finalBalances[tx.destination] += tx.amount;
                    } else if (tx.category === 'adjustment') {
                        if (tx.subCategory === 'Tambah Saldo') {
                            finalBalances[tx.account] += tx.amount;
                        } else { // Kurangi Saldo
                            finalBalances[tx.account] -= tx.amount;
                        }
                    }
                });
                return finalBalances;
            }

            async function renderDashboard() {
                const todayString = new Date().toISOString().split('T')[0];
                const currentBalances = await calculateFinalBalances(todayString);
                
                const container = document.getElementById('current-balances-container');
                container.innerHTML = '';
                for (const [key, name] of Object.entries(ACCOUNTS)) {
                    container.innerHTML += `
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-lg font-medium text-slate-700 flex items-center justify-center">${name}</h3>
                            <p class="text-3xl font-bold text-slate-900 mt-2">${formatCurrency(currentBalances[key] || 0)}</p>
                        </div>
                    `;
                }
            }

            async function getFilteredReportData() {
                const filter = reportFilter.value;
                const now = new Date();
                let startDate, endDate = new Date(now);
                endDate.setHours(23, 59, 59, 999);

                switch (filter) {
                    case 'daily': startDate = new Date(now); startDate.setHours(0, 0, 0, 0); break;
                    case 'weekly': startDate = new Date(now); const d = startDate.getDay(); startDate.setDate(startDate.getDate() - d + (d === 0 ? -6 : 1)); startDate.setHours(0, 0, 0, 0); break;
                    case 'monthly': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
                    case 'yearly': startDate = new Date(now.getFullYear(), 0, 1); break;
                }

                const allTransactions = await getAllData(TX_STORE_NAME);
                return allTransactions.filter(tx => new Date(tx.date) >= startDate && new Date(tx.date) <= endDate);
            }

            async function renderReport() {
                const filtered = await getFilteredReportData();
                
                document.getElementById('total-profit').textContent = formatCurrency(filtered.reduce((sum, tx) => sum + tx.profit, 0));
                document.getElementById('total-transactions').textContent = filtered.length;

                reportBody.innerHTML = '';
                if (filtered.length === 0) {
                    reportBody.innerHTML = `<tr><td colspan="6" class="text-center text-slate-500 p-6">Tidak ada transaksi.</td></tr>`;
                } else {
                    filtered.slice().reverse().forEach(tx => {
                        const row = document.createElement('tr');
                        let detail = tx.customer || tx.description || '';
                        let nominalDisplay = formatCurrency(tx.amount);
                        
                        if (tx.category === 'sale') {
                            nominalDisplay = `${formatCurrency(tx.amount)} -> ${formatCurrency(tx.sellPrice)}`;
                            detail = `${tx.customer} (${ACCOUNTS[tx.source]})`;
                        } else if (tx.subCategory === 'Transfer Uang') {
                            detail = `${tx.customer} (${ACCOUNTS[tx.source]})`;
                        } else if (tx.subCategory === 'Tarik Tunai') {
                            detail = `${tx.customer} (Tunai -> ${ACCOUNTS[tx.destination]})`;
                        } else if (tx.category === 'internal') {
                            detail = `${ACCOUNTS[tx.source]} -> ${ACCOUNTS[tx.destination]}`;
                        } else if (tx.category === 'adjustment') {
                            detail = `${tx.description} (${ACCOUNTS[tx.account]})`;
                            row.classList.add('bg-yellow-50');
                        }

                        row.innerHTML = `
                            <td class="p-3 text-slate-500">${new Date(tx.date).toLocaleString('id-ID', {dateStyle:'short', timeStyle:'short'})}</td>
                            <td class="p-3 font-semibold">${tx.subCategory}</td>
                            <td class="p-3">${detail}</td>
                            <td class="p-3 text-right">${nominalDisplay}</td>
                            <td class="p-3 text-right font-bold text-green-600">${formatCurrency(tx.profit)}</td>
                            <td class="p-3 text-center">
                                <button class="delete-btn text-red-500 hover:text-red-700 transition" data-id="${tx.id}">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </td>
                        `;
                        reportBody.appendChild(row);
                    });
                }
            }
            
            async function checkInitialBalance() {
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                const formContainer = document.getElementById('initial-balances-form');
                
                const todayInitialData = await getData(BALANCE_STORE_NAME, todayString);

                if (todayInitialData) {
                    // Saldo hari ini sudah di-set, kunci form
                    formContainer.innerHTML = '';
                    for (const [key, name] of Object.entries(ACCOUNTS)) {
                        const value = todayInitialData.balances[key] || 0;
                        formContainer.innerHTML += `<div><label class="block text-sm font-medium text-slate-600 mb-1">${name}</label><input type="number" value="${value}" class="w-full p-3 border rounded-lg" disabled></div>`;
                    }
                    saveInitialBalanceBtn.disabled = true;
                    saveInitialBalanceBtn.innerHTML = `<i class="fa-solid fa-lock mr-2"></i> Saldo Terkunci`;
                    saveInitialBalanceBtn.classList.replace('bg-indigo-600', 'bg-slate-400');
                    saveInitialBalanceBtn.classList.remove('hover:bg-indigo-700');
                } else {
                    // Saldo hari ini belum di-set, coba ambil dari hari kemarin
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    const yesterdayString = yesterday.toISOString().split('T')[0];

                    const yesterdayFinalBalances = await calculateFinalBalances(yesterdayString);
                    
                    formContainer.innerHTML = '';
                    for (const [key, name] of Object.entries(ACCOUNTS)) {
                        const value = yesterdayFinalBalances[key] || 0;
                        formContainer.innerHTML += `
                            <div>
                                <label for="initial-${key}" class="block text-sm font-medium text-slate-600 mb-1">${name}</label>
                                <input type="number" id="initial-${key}" data-account-key="${key}" value="${value}" placeholder="0" class="initial-balance-input w-full p-3 border border-slate-300 rounded-lg">
                            </div>
                        `;
                    }
                    saveInitialBalanceBtn.disabled = false;
                    saveInitialBalanceBtn.innerHTML = `<i class="fa-solid fa-floppy-disk mr-2"></i> Atur & Kunci Saldo`;
                    saveInitialBalanceBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    saveInitialBalanceBtn.classList.remove('bg-slate-400');
                }
            }

            // --- FUNGSI GRAFIK ---
            async function renderProfitChart(period = 'daily') {
                const allTransactions = await getAllData(TX_STORE_NAME);
                let chartData = { labels: [], data: [] };
                const now = new Date();

                if (period === 'daily') {
                    const dailyProfits = {};
                    for (let i = 29; i >= 0; i--) {
                        const d = new Date(now);
                        d.setDate(now.getDate() - i);
                        const dateString = d.toISOString().split('T')[0];
                        dailyProfits[dateString] = 0;
                    }
                    allTransactions.forEach(tx => {
                        const dateString = tx.date.split('T')[0];
                        if (dailyProfits[dateString] !== undefined) {
                            dailyProfits[dateString] += tx.profit;
                        }
                    });
                    chartData.labels = Object.keys(dailyProfits).map(d => new Date(d).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }));
                    chartData.data = Object.values(dailyProfits);
                } else if (period === 'monthly') {
                    const monthlyProfits = Array(12).fill(0);
                    const currentYear = now.getFullYear();
                    allTransactions.forEach(tx => {
                        const txDate = new Date(tx.date);
                        if (txDate.getFullYear() === currentYear) {
                            monthlyProfits[txDate.getMonth()] += tx.profit;
                        }
                    });
                    chartData.labels = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
                    chartData.data = monthlyProfits;
                } else if (period === 'yearly') {
                    const yearlyProfits = {};
                    allTransactions.forEach(tx => {
                        const year = new Date(tx.date).getFullYear();
                        if (!yearlyProfits[year]) yearlyProfits[year] = 0;
                        yearlyProfits[year] += tx.profit;
                    });
                    chartData.labels = Object.keys(yearlyProfits).sort();
                    chartData.data = chartData.labels.map(year => yearlyProfits[year]);
                }

                const ctx = document.getElementById('profitChart').getContext('2d');
                if (profitChartInstance) {
                    profitChartInstance.destroy();
                }
                profitChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'Laba',
                            data: chartData.data,
                            borderColor: 'rgb(22, 163, 74)',
                            backgroundColor: 'rgba(22, 163, 74, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) { return 'Rp ' + (value/1000) + 'k'; }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Laba: ${formatCurrency(context.parsed.y)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // --- EVENT LISTENERS ---
            navMenu.addEventListener('click', (e) => e.target.closest('.nav-button') && showPage(e.target.closest('.nav-button').dataset.target));
            categorySelect.addEventListener('change', updateFormLayout);
            subCategorySelect.addEventListener('change', updateFormLayout);
            reportFilter.addEventListener('change', renderReport);
            
            saveInitialBalanceBtn.addEventListener('click', async () => {
                const balances = {};
                let allValid = true;
                document.querySelectorAll('.initial-balance-input').forEach(input => {
                    const value = parseInt(input.value) || 0;
                    if (isNaN(value)) allValid = false;
                    balances[input.dataset.accountKey] = value;
                });

                if (!allValid) { alert('Isi semua saldo awal dengan angka valid.'); return; }

                await saveData(BALANCE_STORE_NAME, { date: new Date().toISOString().split('T')[0], balances });
                alert('Saldo awal disimpan!');
                await checkInitialBalance();
                await renderDashboard();
            });

            transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!await getData(BALANCE_STORE_NAME, new Date().toISOString().split('T')[0])) { alert('Atur saldo awal hari ini dulu!'); return; }

                const category = categorySelect.value;
                const subCategory = subCategorySelect.value;
                let newTransaction = { date: new Date().toISOString(), category, subCategory, profit: 0 };

                if (category === 'flow') {
                    const amount = parseInt(document.getElementById('amount-flow').value);
                    const customer = document.getElementById('customer-flow').value.trim();
                    if (isNaN(amount) || amount <= 0 || !customer) { alert('Isi semua kolom.'); return; }

                    if(subCategory === 'Tarik Tunai') {
                        const destination = document.getElementById('destination-account-flow').value;
                        const adminFeeMethod = document.querySelector('input[name="admin-fee-method"]:checked').value;
                        Object.assign(newTransaction, { amount, customer, destination, adminFeeMethod, profit: calculateAdminFee(amount) });
                    } else { // Transfer Uang
                        const source = document.getElementById('source-account-flow').value;
                        Object.assign(newTransaction, { amount, customer, source, profit: calculateAdminFee(amount) });
                    }
                } else if (category === 'sale') {
                    const basePrice = parseInt(document.getElementById('base-price').value);
                    const sellPrice = parseInt(document.getElementById('sell-price').value);
                    const customer = document.getElementById('customer-sale').value.trim();
                    const source = document.getElementById('source-account-sale').value;
                    if (isNaN(basePrice) || isNaN(sellPrice) || sellPrice < basePrice || !customer) { alert('Isi semua kolom dengan benar.'); return; }
                    Object.assign(newTransaction, { amount: basePrice, sellPrice, customer, source, profit: sellPrice - basePrice });
                } else if (category === 'internal') {
                    const amount = parseInt(document.getElementById('amount-internal').value);
                    const source = document.getElementById('source-account-internal').value;
                    const destination = document.getElementById('destination-account-internal').value;
                    if (isNaN(amount) || amount <= 0 || source === destination) { alert('Isi data transfer dengan benar dan pastikan akun tidak sama.'); return; }
                    Object.assign(newTransaction, { amount, source, destination });
                } else if (category === 'adjustment') {
                    const amount = parseInt(document.getElementById('amount-adjustment').value);
                    const account = document.getElementById('account-adjustment').value;
                    const description = document.getElementById('description-adjustment').value.trim();
                    if (isNaN(amount) || amount <= 0 || !description) { alert('Isi semua kolom penyesuaian saldo.'); return; }
                    Object.assign(newTransaction, { amount, account, description });
                }

                await saveData(TX_STORE_NAME, newTransaction);
                transactionForm.reset();
                updateFormLayout();
                await renderDashboard();
                alert('Transaksi berhasil disimpan!');
                showPage('page-laporan');
            });

            reportBody.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-btn');
                if (deleteButton) {
                    showConfirmationModal({
                        icon: 'fa-solid fa-triangle-exclamation text-5xl text-red-500 mb-4',
                        title: 'Anda Yakin?',
                        text: 'Transaksi ini akan dihapus secara permanen.',
                        action: { type: 'deleteTransaction', id: parseInt(deleteButton.dataset.id) }
                    });
                }
            });

            cancelDeleteBtn.addEventListener('click', hideConfirmationModal);

            confirmDeleteBtn.addEventListener('click', async () => {
                if (!actionToConfirm) return;

                if (actionToConfirm.type === 'deleteTransaction') {
                    await deleteData(TX_STORE_NAME, actionToConfirm.id);
                    await renderDashboard();
                    await renderReport();
                    alert('Transaksi berhasil dihapus.');
                } else if (actionToConfirm.type === 'importDatabase') {
                    await clearData(TX_STORE_NAME);
                    await clearData(BALANCE_STORE_NAME);
                    for (const balance of actionToConfirm.data.balances) {
                        await saveData(BALANCE_STORE_NAME, balance);
                    }
                    for (const tx of actionToConfirm.data.transactions) {
                        await saveData(TX_STORE_NAME, tx);
                    }
                    alert('Data berhasil diimpor!');
                    await checkInitialBalance();
                    await renderDashboard();
                }
                
                hideConfirmationModal();
                actionToConfirm = null;
            });

            exportPdfBtn.addEventListener('click', async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const filteredData = await getFilteredReportData();
                const selectedFilterText = reportFilter.options[reportFilter.selectedIndex].text;
                const totalProfit = filteredData.reduce((sum, tx) => sum + tx.profit, 0);

                doc.setFontSize(18);
                doc.text(`Laporan Keuangan - ${selectedFilterText}`, 14, 22);
                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`Periode: ${new Date().toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'})}`, 14, 30);

                const tableColumn = ["Waktu", "Layanan", "Detail", "Nominal", "Laba"];
                const tableRows = [];

                filteredData.slice().reverse().forEach(tx => {
                    let detail = tx.customer || tx.description || '';
                    let nominalDisplay = formatCurrency(tx.amount);
                    if (tx.category === 'sale') {
                        nominalDisplay = `${formatCurrency(tx.amount)} -> ${formatCurrency(tx.sellPrice)}`;
                        detail = `${tx.customer} (${ACCOUNTS[tx.source]})`;
                    } else if (tx.subCategory === 'Transfer Uang') {
                        detail = `${tx.customer} (${ACCOUNTS[tx.source]})`;
                    } else if (tx.subCategory === 'Tarik Tunai') {
                        detail = `${tx.customer} (Tunai -> ${ACCOUNTS[tx.destination]})`;
                    } else if (tx.category === 'internal') {
                        detail = `${ACCOUNTS[tx.source]} -> ${ACCOUNTS[tx.destination]}`;
                    } else if (tx.category === 'adjustment') {
                        detail = `${tx.description} (${ACCOUNTS[tx.account]})`;
                    }
                    
                    const txData = [
                        new Date(tx.date).toLocaleString('id-ID'),
                        tx.subCategory,
                        detail.replace(/<[^>]*>/g, ''),
                        nominalDisplay.replace(/<[^>]*>/g, ''),
                        formatCurrency(tx.profit)
                    ];
                    tableRows.push(txData);
                });
                
                tableRows.push(["", "", "", "Total Laba:", formatCurrency(totalProfit)]);

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 35,
                    theme: 'grid',
                    headStyles: { fillColor: [22, 160, 133] },
                    foot: [["Total Laba", formatCurrency(totalProfit)]],
                    footStyles: { fillColor: [241, 196, 15] },
                    didDrawPage: function (data) {
                        doc.setFontSize(9);
                        doc.setTextColor(150);
                        doc.text('Laporan dibuat oleh Aplikasi Pencatatan Agen', data.settings.margin.left, doc.internal.pageSize.getHeight() - 10);
                    }
                });
                
                const date = new Date().toISOString().split('T')[0];
                doc.save(`Laporan-${selectedFilterText.replace(' ', '-')}-${date}.pdf`);
            });

            exportDbBtn.addEventListener('click', async () => {
                const transactions = await getAllData(TX_STORE_NAME);
                const balances = await getAllData(BALANCE_STORE_NAME);
                const dataToExport = { transactions, balances };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-agen-app-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });

            importDbBtn.addEventListener('click', () => importFileInput.click());

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.transactions || !data.balances) {
                            throw new Error('Format file backup tidak valid.');
                        }
                        showConfirmationModal({
                            icon: 'fa-solid fa-cloud-upload text-5xl text-blue-500 mb-4',
                            title: 'Konfirmasi Impor Data',
                            text: 'Ini akan MENGHAPUS SEMUA data saat ini dan menggantinya dengan data dari file. Lanjutkan?',
                            action: { type: 'importDatabase', data }
                        });
                    } catch (error) {
                        alert(`Gagal membaca file backup: ${error.message}`);
                    }
                };
                reader.readAsText(file);
                importFileInput.value = ''; // Reset input
            });

            chartFilterButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.chart-filter-btn');
                if (button) {
                    chartFilterButtons.querySelectorAll('.chart-filter-btn').forEach(btn => {
                        btn.classList.remove('bg-white', 'text-cyan-600', 'shadow');
                        btn.classList.add('text-slate-500');
                    });
                    button.classList.add('bg-white', 'text-cyan-600', 'shadow');
                    button.classList.remove('text-slate-500');
                    renderProfitChart(button.dataset.period);
                }
            });

            // --- INISIALISASI ---
            async function main() {
                await initDB();
                populateAccountSelects();
                await checkInitialBalance();
                await renderDashboard();
                updateFormLayout();
                showPage('page-dashboard');
            }
            main();
        });
    </script>
</body>
</html>
